@page "/"
@using Microsoft.AspNetCore.Components.Forms
@using System.Text
@inject BlazorDownloadFile.IBlazorDownloadFileService BlazorDownloadFileService

<InputFile id="fileInput" OnChange="@LoadSaveFile" hidden />

<MudCard>
	<MudCardHeader>
		<MudText Typo="Typo.h6" Align="Align.Center">Welcome to the ugliest save editor for Pulsar: Lost Colony!</MudText>
	</MudCardHeader>
	<MudCardContent>
		@if(Save.CurrentSave == null)
		{
			<MudText Typo="Typo.body2">To get started, select the save by clicking the button below!</MudText>
		}
		else
		{
			<MudText Typo="Typo.body2">Buttons to load another save or save the current one:</MudText>
		}
	</MudCardContent>
	<MudCardActions>
		<MudButton HtmlTag="label"
           Variant="Variant.Text" Color="Color.Primary"
           StartIcon="@Icons.Filled.FileUpload"
           for="fileInput">
		Select Save
		</MudButton>
		@if(Save.CurrentSave != null)
		{
			<MudButton Variant="Variant.Text" Color="Color.Primary"
				StartIcon="@Icons.Filled.FileDownload"
				OnClick="@SendSave">
				Download Save
			</MudButton>
		}
		<MudButton Variant="Variant.Text" Color="Color.Primary"
				StartIcon="@Icons.Filled.Refresh"
				OnClick="@ForceUpdate">
				Rebuild UI
			</MudButton>
	</MudCardActions>
</MudCard>

@if(Save.CurrentSave != null)
{
	<MudCard>
		<MudCardHeader>
			<MudText Typo="Typo.h6">Main Save Info</MudText>
		</MudCardHeader>
		<MudCardContent>
			<MudGrid>
				<MudItem xs="12" sm="4">  
					<MudTextField @bind-Value="Save.CurrentSave.GameName" Label="Game Name" Margin="Margin.Dense" Variant="Variant.Outlined"/> 
				</MudItem>
				<MudItem xs="12" sm="4">  
					<MudNumericField @bind-Value="Save.CurrentSave.SaveVerID" Label="Save Version" Margin="Margin.Dense" Variant="Variant.Outlined"/> 
				</MudItem>
				<MudItem xs="12" sm="4"> 
					<MudNumericField @bind-Value="Save.CurrentSave.GalaxySaveVerID" Label="Galaxy Save Version" Margin="Margin.Dense" Variant="Variant.Outlined"/> 
				</MudItem>
				<MudItem xs="12" sm="4"> 
					<MudDatePicker @bind-Date="Save.CurrentSave.SavedDateTime" Label="Galaxy Save Version" Margin="Margin.Dense" Variant="Variant.Outlined"/> 
				</MudItem>
				<MudItem xs="12" sm="4"> 
					<MudNumericField @bind-Value="Save.CurrentSave.GalaxySeed" Label="Galaxy Seed" Margin="Margin.Dense" Variant="Variant.Outlined"/> 
				</MudItem>
				<MudItem xs="12" sm="4"> 
					<MudCheckBox @bind-Checked="Save.CurrentSave.IronmanMode" Label="Is Ironman Mode" Margin="Margin.Dense" Variant="Variant.Outlined"/> 
				</MudItem>
				<MudItem xs="12" sm="4"> 
					<MudCheckBox @bind-Checked="Save.CurrentSave.PacifistRun" Label="Is Pacifist Run" Margin="Margin.Dense" Variant="Variant.Outlined"/> 
				</MudItem>
				<MudItem xs="12" sm="4"> 
					<MudCheckBox @bind-Checked="Save.CurrentSave.OfflineGame" Label="Is Offline Game" Margin="Margin.Dense" Variant="Variant.Outlined"/> 
				</MudItem>
			</MudGrid>
		</MudCardContent>
	</MudCard>

	<MudCard>
		<MudCardHeader>
			<MudText Typo="Typo.h6" Align="Align.Center">Game Statistics</MudText>
		</MudCardHeader>
		<MudCardContent>
			<MudGrid>
				<MudItem xs="12" sm="4"> 
					<MudNumericField @bind-Value="Save.CurrentSave.GameTime" Label="Game Time" Margin="Margin.Dense" Variant="Variant.Outlined"/> 
				</MudItem>
				<MudItem xs="12" sm="4"> 
					<MudNumericField @bind-Value="Save.CurrentSave.Playtime" Label="Playtime" Margin="Margin.Dense" Variant="Variant.Outlined"/> 
				</MudItem>
				<MudItem xs="12" sm="4">  
					<MudNumericField @bind-Value="Save.CurrentSave.EnemyKills" Label="Enemy Kills" Margin="Margin.Dense" Variant="Variant.Outlined"/> 
				</MudItem>
				<MudItem xs="12" sm="4"> 
					<MudNumericField @bind-Value="Save.CurrentSave.NumJumps" Label="Jumps" Margin="Margin.Dense" Variant="Variant.Outlined"/> 
				</MudItem>
				<MudItem xs="12" sm="4"> 
					<MudCheckBox @bind-Checked="Save.CurrentSave.FlaggedNonExpertAtAnyTime" Label="FlaggedNonExpertAtAnyTime" Margin="Margin.Dense" Variant="Variant.Outlined"/> 
				</MudItem>
				<MudItem xs="12" sm="4"> 
					<MudCheckBox @bind-Checked="Save.CurrentSave.PS_EndGameSequenceActive" Label="End Game Sequence Active" Margin="Margin.Dense" Variant="Variant.Outlined"/> 
				</MudItem>
				<MudItem xs="12" sm="4"> 
					<MudNumericField @bind-Value="Save.CurrentSave.CreditsSpent_InRun" Label="Credits Spent In Run" Margin="Margin.Dense" Variant="Variant.Outlined"/> 
				</MudItem>
				<MudItem xs="12" sm="4"> 
					<MudNumericField @bind-Value="Save.CurrentSave.BlindJumpCount" Label="Blind Jump Count" Margin="Margin.Dense" Variant="Variant.Outlined"/> 
				</MudItem>
			</MudGrid>
		</MudCardContent>
	</MudCard>

	<MudCard>
		<MudCardHeader>
			<MudText Typo="Typo.h6" Align="Align.Center">Some Biscuits Things</MudText>
		</MudCardHeader>
		<MudCardContent>
			<MudGrid>
				<MudItem xs="12" sm="4">  
					<MudNumericField @bind-Value="Save.CurrentSave.PS_BiscuitsSold" Label="Biscuits Sold" Margin="Margin.Dense" Variant="Variant.Outlined"/> 
				</MudItem>
				<MudItem xs="12" sm="4"> 
					<MudNumericField @bind-Value="Save.CurrentSave.PS_BiscuitsSold_WhenContestEnded" Label="WhenContestEnded" Margin="Margin.Dense" Variant="Variant.Outlined"/> 
				</MudItem>
				<MudItem xs="12" sm="4"> 
					<MudNumericField @bind-Value="Save.CurrentSave.PerfectBiscuitStreak" Label="Perfect Biscuit Streak" Margin="Margin.Dense" Variant="Variant.Outlined"/> 
				</MudItem>
				<MudItem xs="12" sm="4"> 
					<MudNumericField @bind-Value="Save.CurrentSave.PS_FBCrateSupply" Label="FB Crates" Margin="Margin.Dense" Variant="Variant.Outlined"/> 
				</MudItem>
				<MudItem xs="12" sm="4"> 
					<MudCheckBox @bind-Checked="Save.CurrentSave.PS_BiscuitsSold_WonFBContest" Label="WonFBContest" Margin="Margin.Dense" Variant="Variant.Outlined"/> 
				</MudItem>
				<MudItem xs="12" sm="4"> 
					<MudCheckBox @bind-Checked="Save.CurrentSave.BiscuitContestIsOver" Label="BiscuitContestIsOver" Margin="Margin.Dense" Variant="Variant.Outlined"/> 
				</MudItem>
				<MudItem xs="12" sm="4"> 
					<MudCheckBox @bind-Checked="Save.CurrentSave.PS_BBAvailable" Label="BiscuitBombs Avialable" Margin="Margin.Dense" Variant="Variant.Outlined"/> 
				</MudItem>
			</MudGrid>
		</MudCardContent>
	</MudCard>

	<MudCard>
		<MudCardHeader>
			<MudText Typo="Typo.h6" Align="Align.Center">Bounty Hunter Data</MudText>
		</MudCardHeader>
		<MudCardContent>
			<MudGrid>
				<MudItem xs="12" sm="12">
					<MudText>Active Bounty Hunter Data</MudText>
				</MudItem>
				<MudItem xs="12" sm="4">  
					<MudNumericField @bind-Value="Save.CurrentSave.ActiveBountyHunter_SectorID" Label="Sector ID" Margin="Margin.Dense" Variant="Variant.Outlined"/> 
				</MudItem>
				<MudItem xs="12" sm="4"> 
					<MudNumericField @bind-Value="Save.CurrentSave.ActiveBountyHunter_SecondsSinceWarp" Label="Seconds Since Warp" Margin="Margin.Dense" Variant="Variant.Outlined"/> 
				</MudItem>
				<MudItem xs="12" sm="4"> 
					<MudNumericField @bind-Value="Save.CurrentSave.ActiveBountyHunter_TypeID" Label="Type ID" Margin="Margin.Dense" Variant="Variant.Outlined"/> 
				</MudItem>
				<MudItem xs="12" sm="4"> 
					<MudNumericField @bind-Value="Save.CurrentSave.ActiveBountyHunter_ProcessedChaosLevel" Label="Processed Chaos Level" Margin="Margin.Dense" Variant="Variant.Outlined"/> 
				</MudItem>
				<MudItem xs="12" sm="4"> 
					<MudCheckBox @bind-Checked="Save.CurrentSave.BHI_Exists" Label="BHI Exists" Margin="Margin.Dense" Variant="Variant.Outlined"/> 
				</MudItem>
				@if(Save.CurrentSave.BHI_Exists)
				{
					<MudItem xs="12" sm="4"> 
						<MudNumericField @bind-Value="Save.CurrentSave.BHI_HullPercent" Label="BHI Hull Percent" Margin="Margin.Dense" Variant="Variant.Outlined"/> 
					</MudItem>
					<MudItem xs="12" sm="4"> 
						<MudTextField @bind-Value="Save.CurrentSave.BHI_ShipName" Label="BHI Ship Name" Margin="Margin.Dense" Variant="Variant.Outlined"/> 
					</MudItem>
					<MudItem xs="12" sm="4"> 
						<MudNumericField @bind-Value="Save.CurrentSave.BHI_ShipType" Label="BHI Ship Type" Margin="Margin.Dense" Variant="Variant.Outlined"/> 
					</MudItem>
				}
				<MudItem xs="12" sm="4"> 
					<MudCheckBox @bind-Checked="Save.CurrentSave.BHL_Exists" Label="BHL Exists" Margin="Margin.Dense" Variant="Variant.Outlined"/> 
				</MudItem>
				@if(Save.CurrentSave.BHI_Exists)
				{
					<MudItem xs="12" sm="4"> 
						<MudTextField @bind-Value="Save.CurrentSave.BHL_Data" Label="BHL Data" Margin="Margin.Dense" Variant="Variant.Outlined"/> 
					</MudItem>
					<MudItem xs="12" sm="4"> 
						<MudTextField @bind-Value="Save.CurrentSave.BHL_Crew" Label="BHL Crew" Margin="Margin.Dense" Variant="Variant.Outlined"/> 
					</MudItem>
				}
				<MudItem xs="12" sm="12">
					<MudText>Misc</MudText>
				</MudItem>
				<MudItem xs="12" sm="4"> 
					<MudNumericField @bind-Value="Save.CurrentSave.BountyHuntersSpawned" Label="Bounty Hunters Spawned" Margin="Margin.Dense" Variant="Variant.Outlined"/> 
				</MudItem>
			</MudGrid>
		</MudCardContent>
	</MudCard>

	<MudCard>
		<MudCardHeader>
			<MudText Typo="Typo.h6"></MudText>
		</MudCardHeader>
		<MudCardContent>
			<MudGrid>

			</MudGrid>
		</MudCardContent>
	</MudCard>
}

@code {
	private async void LoadSaveFile(InputFileChangeEventArgs e)
	{
		byte[] bytes = new byte[e.File.Size];
		await e.File.OpenReadStream(1048576 /* 1 kb */).ReadAsync(bytes, 0, (int)e.File.Size);
		Save.CurrentSave = Save.LoadFromFile(new BinaryReader(new MemoryStream(bytes)), e.File.Name);
		await this.InvokeAsync(this.StateHasChanged);
	}

	private async void SendSave()
	{
		await BlazorDownloadFileService.DownloadFile(Save.CurrentSave.FileName, Save.SaveToBytes(), "application/octet-stream");
	}

	private async void ForceUpdate()
	{
		await this.InvokeAsync(this.StateHasChanged);
	}
}